<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=0.8">
<title>Запись на услуги</title>
<style>
	.calendar-day {
		width: 40px;
		height: 40px; 
		margin: 3px;
		line-height: 40px;
		text-align: center;
		border-radius: 8px; 
		cursor: pointer;
		font-weight: bold;
		font-size: 16px;
	}
	.bt{
		left: 4%;
		position: relative;
	    width: 90%;
	}
	#calendar {
		display: flex;
		flex-wrap: wrap;
		width: 280px;
		margin-top: 10px;
	}
	.active-date { 
		background-color: #EC3B86; 
		color: white; 
	}	

	label { 
		display: block; 
		margin-top: 15px; 
		font-size: 18px; 
	}
	#time-option {
		padding: 10px 15px;
		background-color: #eee;
		border-radius: 5px;
		cursor: pointer;
		font-size: 16px;
	}
	input, button {
		margin-top: 10px;
		padding: 12px 15px;
		font-size: 18px;
		border-radius: 5px;
		border: 1px solid #ccc;
	}
	
	button {
		margin: 4px; 
		background-color: #db39d5;
		color: white; border: none; 
		cursor: pointer;
	}
		button-secondary {
		background-color: #db39d5;
		color: white;
		border: none;
		cursor: pointer;
		transition: background-color 0.3s;
	}
	
	body { 
		margin: 0; 
		font-family: Arial, sans-serif;
	}
	.container { 
		margin: 20px;
		margin-top: 20px;
	}
	
	.header {
		background: linear-gradient(to top, #e27662, #e6497b);
		padding: 20px; 
		text-align: center; 
		color: white;
	}
</style>
</head>
<body>

<div class="header">
    <h2>Запись на услуги</h2>
</div>

<div class="container">     
		<div><strong>Выбранные услуги:</strong> <span id="servicesList"></span></div>
		<div id="chosenInfo" style="margin-top:15px; font-weight:bold;"></div>
    <form id="datetimeForm">
        <label>Имя *</label>
        <input type="text" id="name" name="name" required>

        <label>Телефон *</label>
        <input type="tel" id="phone" name="phone" required>

        <label>Дата:</label>
        <div id="calendar"></div>

        <input type="hidden" style="display: flex; flex-wrap: wrap;" id="selectedDate" name="selectedDate" required>
        <input type="hidden" id="selectedTime" name="selectedTime" required>
        <input type="hidden" id="servicesListInput" name="servicesList">
		

        <div id="timeSelection" class="time-option">
            <h3>Выберите время</h3>
            <div id="timeSlotContainer" data-role="time-slot"></div>
			</div>        
        </div>

		<button type="submit" class="bt">Записаться</button>
    </form>
</div>
<script>
document.addEventListener("DOMContentLoaded", function() {
  var input = document.querySelector(".maskphone");

  input.addEventListener("input", mask);
  input.addEventListener("focus", mask);
  input.addEventListener("blur", mask);

  function mask(event) {
    var blank = "+_ (___) ___-__-__";
    var i = 0;
    var val = this.value.replace(/\D/g, "").replace(/^8/, "7"); // заменяем 8 на 7

    var formatted = blank.replace(/./g, function(char) {
      if (/[_\d]/.test(char) && i < val.length) return val.charAt(i++);
      return i >= val.length ? "" : char;
    });

    // Добавляем одинарную кавычку перед +7, если её ещё нет
    if (formatted.startsWith("+7") && !formatted.startsWith("'+7")) {
      formatted = "'" + formatted;
    }

    this.value = formatted;

    if (event.type == "blur") {
      if (this.value.length <= 2) this.value = "";
    } else {
      setCursorPosition(this, this.value.length);
    }
  }

  function setCursorPosition(elem, pos) {
    if (elem.setSelectionRange) {
      elem.focus();
      elem.setSelectionRange(pos, pos);
    } else if (elem.createTextRange) {
      var range = elem.createTextRange();
      range.collapse(true);
      range.moveEnd("character", pos);
      range.moveStart("character", pos);
      range.select();
    }
  }

  /***/
  function setCursorPosition(elem, pos) {
    elem.focus();
    
    if (elem.setSelectionRange) {    
      elem.setSelectionRange(pos, pos);
      return;
    }
    
    if (elem.createTextRange) {    
      var range = elem.createTextRange();
      range.collapse(true);
      range.moveEnd("character", pos);
      range.moveStart("character", pos);
      range.select();      
      return;
    }
  }
});

    const phoneInput = document.getElementById('phone');

    phoneInput.addEventListener('input', () => {
      let value = phoneInput.value;

      // Если введённая строка начинается с 9 без префикса
      if (/^9\d*/.test(value)) {
        phoneInput.value = '+7' + value;
      }

      // Если пользователь ввёл 89..., заменяем 8 на +7
      if (/^8\d{0,10}/.test(value)) {
        phoneInput.value = '+7' + value.slice(1);
      }
    });
</script>
<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
<script>
const firebaseConfig = {
    apiKey: "AIzaSyAfhCZdJyM_ZHhszrhYBAhcc2jtaSN4Z0A",
    authDomain: "waynerd07.firebaseapp.com",
    databaseURL: "https://waynerd07-default-rtdb.firebaseio.com",
    projectId: "waynerd07",
    storageBucket: "waynerd07.appspot.com",
    messagingSenderId: "338435412693",
    appId: "1:338435412693:web:70f11cf491cfb96cadc85c"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// Загружаем услуги из localStorage
const servicesListEl = document.getElementById('servicesList');
const selectedServices = JSON.parse(localStorage.getItem('selectedServices') || '[]');
servicesListEl.textContent = selectedServices.length ? selectedServices.join(', ') : 'Услуги не выбраны';
document.getElementById('servicesListInput').value = selectedServices.join(', ');

// Загрузка дат
function loadDates() {
    db.ref('availableDates').on('value', snapshot => {
        const dates = snapshot.val() || {};
        const calendar = document.getElementById('calendar');
        calendar.innerHTML = '';

        Object.entries(dates).forEach(([date, slots]) => {
            const hasFree = Object.values(slots).some(slot => slot.available === true);
            if (hasFree) {
                const div = document.createElement('div');
                div.className = 'calendar-day active-date';
                div.textContent = date;
                div.dataset.date = date;
                div.addEventListener('click', () => showTimeSlots(date));
                calendar.appendChild(div);
            }
        });
    });
}

// Показ времени
function showTimeSlots(date) {
    document.getElementById('selectedDate').value = date;
    document.getElementById('timeSelection').style.display = 'block';
    const container = document.getElementById('timeSlotContainer');
    container.innerHTML = 'Загрузка...';

    db.ref(`availableDates/${date}`).once('value').then(snapshot => {
        const times = snapshot.val() || {};
        container.innerHTML = '';

        Object.entries(times).forEach(([time, data]) => {
            if (data.available === true) {
                const btn = document.createElement('button');
                btn.type = 'button';
                btn.textContent = time;
                btn.addEventListener('click', () => {
                    document.getElementById('selectedTime').value = time;
                    document.getElementById('chosenInfo').textContent = `Вы выбрали: ${date}, ${time}`;
                });
                container.appendChild(btn);
            }
        });

        if (!container.innerHTML) container.textContent = 'Нет доступного времени.';
    });
}

// Отправка формы
document.getElementById('datetimeForm').addEventListener('submit', function(e) {
    e.preventDefault();

    const name = document.getElementById('name').value;
    const phone = document.getElementById('phone').value;
    const date = document.getElementById('selectedDate').value;
    const time = document.getElementById('selectedTime').value;
    const services = document.getElementById('servicesListInput').value;

    if (!date || !time) {
        alert('Выберите дату и время!');
        return;
    }

    // 1. Запись в Firebase с данными клиента
    db.ref(`availableDates/${date}/${time}`).set({
        available: false,
        name: name,
        phone: phone,
        services: services
    }).then(() => {
        // 2. Отправка в Google Таблицы
        const formData = new FormData(e.target);
        fetch('https://script.google.com/macros/s/AKfycby0v0vB1GAlxdKSslmNF0JwOfktWkM54wOBY8_j_FUCzr7WJzwMoQZGEpWn8HodLTz0/exec', {
            method: 'POST',
            body: formData
        })
        .then(r => r.text())
		.then(() => {
			window.location.href = "thanks.html"; // имя страницы с благодарностью
		})
        .catch(err => alert('Ошибка отправки: ' + err));
    })
    .catch(err => alert('Ошибка бронирования: ' + err.message));
});

document.addEventListener('DOMContentLoaded', loadDates);
</script>
</body>
</html>


